generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  // Pooled connection string (PgBouncer / Transaction pooler)
  url       = env("DATABASE_URL")
  // Direct connection string (used by Prisma for migrations and some tooling)
  directUrl = env("DIRECT_DATABASE_URL")
}

model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?    @db.Text
  image       String?
  parentId    String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id                 String              @id @default(cuid())
  name               String
  slug               String              @unique
  description        String              @db.Text
  shortDescription   String?             @db.VarChar(500)
  sku                String?             @unique
  price              Decimal             @db.Decimal(10, 2)
  compareAtPrice     Decimal?            @db.Decimal(10, 2)
  costPrice          Decimal?            @db.Decimal(10, 2)
  stock              Int                 @default(0)
  lowStockThreshold  Int                 @default(10)
  trackInventory     Boolean             @default(true)
  allowBackorder     Boolean             @default(false)
  categoryId         String?
  brand              String?
  tags               String?             @db.VarChar(1000)
  featuredImage      String?
  weight             Decimal?            @db.Decimal(10, 2)
  length             Decimal?            @db.Decimal(10, 2)
  width              Decimal?            @db.Decimal(10, 2)
  height             Decimal?            @db.Decimal(10, 2)
  metaTitle          String?             @db.VarChar(255)
  metaDescription    String?             @db.VarChar(500)
  isActive           Boolean             @default(true)
  isFeatured         Boolean             @default(false)
  isNewArrival       Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  publishedAt        DateTime?
  orderItems         OrderItem[]
  images             ProductImage[]
  colors             ProductColor[]
  specifications     ProductSpecification[]
  category           Category?           @relation(fields: [categoryId], references: [id])
  reviews            Review[]
  stockNotifications StockNotification[]
  recentlyViewed     RecentlyViewed[]
  savedCartItems     SavedCartItem[]
  bundleItems        ProductBundleItem[]

  @@index([categoryId])
  @@index([brand])
  @@index([slug])
  @@index([sku])
  @@index([isActive, isFeatured])
  @@index([createdAt])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  position  Int      @default(0)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isPrimary])
  @@map("product_images")
}

model ProductColor {
  id         String      @id @default(cuid())
  productId  String
  name       String // e.g., "Red", "Blue", "Black"
  value      String // Hex color code e.g., "#FF0000"
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([productId])
  @@index([isActive])
  @@map("product_colors")
}

model ProductSpecification {
  id         String      @id @default(cuid())
  productId  String
  type       String      // e.g., "Size", "Flavor", "Weight"
  name       String      // e.g., "250g", "Mint", "Gum with Mint"
  value      String?     // Optional value (e.g., "250" for size)
  isActive   Boolean     @default(true)
  position   Int         @default(0) // For ordering
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([productId])
  @@index([type])
  @@index([isActive])
  @@map("product_specifications")
}

model ProductBundle {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2) // Bundle price (usually discounted)
  discount    Decimal? @db.Decimal(10, 2) // Discount amount
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  items       ProductBundleItem[]

  @@index([isActive])
  @@map("product_bundles")
}

model ProductBundleItem {
  id          String        @id @default(cuid())
  bundleId    String
  productId   String
  quantity    Int           @default(1)
  bundle      ProductBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([bundleId, productId])
  @@index([bundleId])
  @@index([productId])
  @@map("product_bundle_items")
}

model Order {
  id              String  @id @default(cuid())
  orderNumber     String  @unique
  userId          String
  userEmail       String
  userName        String
  userPhone       String
  deliveryAddress String  @db.Text
  deliveryCity    String
  deliveryNotes   String? @db.Text

  // Location Coordinates (for map-based delivery)
  deliveryLatitude  Float?
  deliveryLongitude Float?

  subtotal           Decimal        @db.Decimal(10, 2)
  deliveryFee        Decimal        @default(0.00) @db.Decimal(10, 2)
  tax                Decimal        @default(0.00) @db.Decimal(10, 2)
  discount           Decimal        @default(0.00) @db.Decimal(10, 2)
  total              Decimal        @db.Decimal(10, 2)
  status             OrderStatus    @default(PENDING)
  paymentStatus      PaymentStatus  @default(PENDING)
  trackingNumber     String?
  estimatedDelivery  DateTime?
  scheduledDelivery  DateTime? // For scheduled deliveries
  deliveredAt        DateTime?
  adminNotes         String?        @db.Text
  cancellationReason String?        @db.Text
  deliveryAddressId  String? // Reference to saved address
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  cancelledAt        DateTime?
  notifications      Notification[]
  items              OrderItem[]
  payment            Payment?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([scheduledDelivery])
  @@map("orders")
}

model OrderItem {
  id           String        @id @default(cuid())
  orderId      String
  productId    String
  productName  String
  productSku   String?
  productImage String?
  colorId      String?
  colorName    String?
  colorValue   String? // Hex color code
  specId       String?
  specType     String? // e.g., "Size", "Flavor"
  specName     String? // e.g., "250g", "Mint"
  specValue    String? // Optional value
  price        Decimal       @db.Decimal(10, 2)
  quantity     Int
  subtotal     Decimal       @db.Decimal(10, 2)
  createdAt    DateTime      @default(now())
  order        Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product       @relation(fields: [productId], references: [id])
  color        ProductColor? @relation(fields: [colorId], references: [id])
  specification ProductSpecification? @relation(fields: [specId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([colorId])
  @@index([specId])
  @@map("order_items")
}

model Payment {
  id                        String        @id @default(cuid())
  orderId                   String        @unique
  method                    PaymentMethod
  mpesaPhone                String?
  mpesaReceiptNumber        String?       @unique
  mpesaTransactionId        String?       @unique
  mpesaCheckoutRequestId    String?       @unique
  paystackReference         String?       @unique
  paystackAuthorizationCode String?
  paystackCustomerCode      String?
  paystackChannel           String?
  cardLast4                 String?
  cardBrand                 String?
  bankReference             String?
  amount                    Decimal       @db.Decimal(10, 2)
  currency                  String        @default("KES")
  status                    PaymentStatus @default(PENDING)
  providerResponse          String?       @db.Text
  errorMessage              String?       @db.Text
  paidAt                    DateTime?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  order                     Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([mpesaReceiptNumber])
  @@index([mpesaTransactionId])
  @@index([paystackReference])
  @@map("payments")
}

model Review {
  id           String   @id @default(cuid())
  productId    String
  userId       String
  userName     String
  userEmail    String
  rating       Int
  title        String?
  comment      String   @db.Text
  isVerified   Boolean  @default(false)
  isApproved   Boolean  @default(false)
  helpfulCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@map("reviews")
}

model Notification {
  id             String              @id @default(cuid())
  orderId        String?
  recipientEmail String
  recipientPhone String?
  type           NotificationType
  channel        NotificationChannel
  subject        String?
  message        String              @db.Text
  status         NotificationStatus  @default(PENDING)
  sentAt         DateTime?
  errorMessage   String?             @db.Text
  metadata       String?             @db.Text
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  order          Order?              @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

model Settings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  category    String   @default("general")
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("settings")
}

model AdminLog {
  id          String   @id @default(cuid())
  adminId     String
  adminEmail  String
  action      String
  entity      String
  entityId    String?
  description String   @db.Text
  metadata    String?  @db.Text
  ipAddress   String?
  userAgent   String?  @db.Text
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("admin_logs")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  MPESA
  PAYSTACK
  CARD
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

enum NotificationType {
  ORDER_CONFIRMATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  LOW_STOCK_ALERT
  ADMIN_ALERT
}

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
}

model StockNotification {
  id         String    @id @default(cuid())
  productId  String
  userId     String? // null for guest users
  email      String
  phone      String?
  notified   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  notifiedAt DateTime?
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, email])
  @@index([productId])
  @@index([userId])
  @@index([notified])
  @@map("stock_notifications")
}

model SavedSearch {
  id          String   @id @default(cuid())
  userId      String
  name        String?
  searchQuery String   @db.Text
  filters     String?  @db.Text // JSON string of filters
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("saved_searches")
}

model DeliveryAddress {
  id            String   @id @default(cuid())
  userId        String
  label         String // e.g., "Home", "Work"
  fullName      String
  phone         String
  address       String   @db.Text
  city          String
  latitude      Float?
  longitude     Float?
  isDefault     Boolean  @default(false)
  deliveryNotes String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@map("delivery_addresses")
}

model RecentlyViewed {
  id        String   @id @default(cuid())
  userId    String? // null for guest (stored in session)
  sessionId String? // for guest users
  productId String
  viewedAt  DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@unique([sessionId, productId])
  @@index([userId])
  @@index([sessionId])
  @@index([viewedAt])
  @@map("recently_viewed")
}

model SavedCartItem {
  id        String   @id @default(cuid())
  userId    String? // null for guest
  sessionId String? // for guest users
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@unique([sessionId, productId])
  @@index([userId])
  @@index([sessionId])
  @@map("saved_cart_items")
}

model FlashSale {
  id              String   @id @default(cuid())
  title           String
  description     String?  @db.Text
  productIds      String   @db.Text // JSON array of product IDs
  discountPercent Decimal  @db.Decimal(5, 2)
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("flash_sales")
}

model WishlistShare {
  id           String   @id @default(cuid())
  wishlistId   String // userId or sessionId
  shareToken   String   @unique
  wishlistData String   @db.Text // JSON string of wishlist items
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([shareToken])
  @@map("wishlist_shares")
}

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
  @@map("newsletter_subscribers")
}
